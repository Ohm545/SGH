<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dang Civic Connect - Digital Grievance Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #3730a3;
            --accent: #059669;
            --dark: #1e1b4b;
            --light: #f8fafc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            /* background: url("D:\Downloads\4990245-hd_1920_1080_30fps.mp4"); */
            /* background: #f1f5f9; */
            color: var(--dark);
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 30px;
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Modern Navigation */
        .nav-column {
            position: sticky;
            top: 30px;
            height: calc(100vh - 60px);
            min-width: 280px;
        }
        .nav-column-inner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 20px;
            padding: 25px;
            height: 100%;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
            overflow-y: auto;
        }
        @media (max-width: 1200px) {
            .nav-column {
                position: static;
                height: auto;
            }
            .nav-column-inner {
                height: auto;
            }
        }
        .nav-button {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            padding: 18px;
            margin-bottom: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            font-weight: 500;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(8px);
        }

        .active-section {
            background: white !important;
            color: var(--primary) !important;
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.15);
        }

        /* Content Area Styling */
        .content-area {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }

        .section-header, h2 {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 30px;
            position: relative;
            padding-left: 20px;
        }

        .section-header::before, h2::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 70%;
            width: 5px;
            background: var(--primary);
            border-radius: 5px;
        }

        /* News Section Design */
        .news-grid, #newsContent {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .news-card, .news-item {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }

        .news-card:hover, .news-item:hover {
            transform: translateY(-5px);
        }

        .news-card h3, .news-item h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 20px;
        }

        /* Statistics Dashboard */
        .stats-grid, #stats-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin: 15px 0;
        }

        /* Modern Form Design */
        .complaint-form, #complaint {
            /* background: var(--light); */
            background: #edf4fb;

            padding: 30px;
            border-radius: 20px;
        }
        #complaintChart {
            max-width: 400px;
            max-height: 400px;
            margin: auto;
        }
        h3 {
        font-size: 22px;
        font-weight: bold;
        color: #ff6600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.2);
        margin-bottom: 15px;
    }
        .form-heading {
            font-size: 24px;
            color: var(--dark);
            text-align: center;
            margin-bottom: 35px;
            position: relative;
        }

        .form-heading::after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background: var(--primary);
            margin: 10px auto 0;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
            font-size: 15px;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 15px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        /* Complaints List */
        .complaints-list {
            margin-top: 40px;
        }

        .complaint-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
            transition: transform 0.3s ease;
        }

        .complaint-card:hover {
            transform: translateX(5px);
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status-item {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .status-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 24px;
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--primary);
        }

        /* Update contrast for status badges */
        .pending { background: #f59e0b; color: white; }
        .in-progress { background: #3b82f6; color: white; }
        .resolved { background: #10b981; color: white; }

        /* Add form field styling */
        .form-field-group {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        fieldset {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        legend {
            padding: 0 10px;
            font-weight: 600;
            color: var(--primary);
        }

        /* Fix hidden class */
        .hidden { display: none; }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                padding: 20px;
            }

            .nav-column {
                position: static;
                height: auto;
            }

            .nav-button {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .two-col {
                grid-template-columns: 1fr;
            }

            .section-header, h2 {
                font-size: 24px;
            }
        }

        /* Interactive Elements */
        button[type="submit"] {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 16px 35px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-top: 20px;
            width: fit-content; /* Makes the button only as wide as needed */
            max-width: 100%; /*Prevents overflow on small screens*/
        }

        button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
        }

        /* Status Section */
        .status-timeline, .status-section {
            border-left: 3px solid #e2e8f0;
            margin-left: 10px;
            padding-left: 25px;
        }

        .complaint-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .complaint-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .action-btn {
            background: var(--light);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
        }

        #stats-content p {
            background: var(--light);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 500;
        }

        #stats-content span {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }

        /* Enhanced UI Elements */
        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            transform: rotate(30deg);
            pointer-events: none;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #mainContent > div:not(.hidden) {
            animation: fadeIn 0.3s ease-out;
        }

        /* Improved Form Styling */
        input:hover, select:hover, textarea:hover {
            border-color: #cbd5e1;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .required-star {
            color: #ef4444;
            font-size: 14px;
        }

        /* Improved Status Badges */
        .status-badge {
            position: relative;
            overflow: hidden;
        }

        .status-badge::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }
        .modal { pointer-events: auto !important; }

        @keyframes shimmer {
            to { left: 100%; }
        }
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            /* Remove overflow: hidden */
        }

        .video-background {
            position: fixed; /* Keep the video fixed */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Ensure it stays behind the content */
            overflow: hidden; /* Hide overflow for the video */
        }

        #bg-video {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translate(-50%, -50%);
        }

        .content-area {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            position: relative; /* Add this */
            height: calc(100vh - 60px); /* Set a fixed height */
            overflow-y: auto; /* Enable scrolling */
            scrollbar-width: none; /* Hide scrollbar for Firefox */
            -ms-overflow-style: none; /* Hide scrollbar for IE/Edge */
}
/* Profile Section Styles */
.profile-content {
    background: #f8f9fa;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.profile-content input[readonly] {
    background-color: #f1f3f5;
    border: 1px solid #dee2e6;
}

.profile-content input:not([readonly]) {
    background-color: white;
    border: 1px solid #ced4da;
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
}

.btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-2px);
}
/* Hide scrollbar for Chrome/Safari */
.content-area::-webkit-scrollbar {
    display: none;
}
/* Add to your existing styles */
.modal {
  pointer-events: all !important;
}
.modal-content {
  pointer-events: all !important;
}
.modal input, 
.modal textarea, 
.modal select {
  pointer-events: all !important;
}
.modal {
    z-index: 1050 !important;  /* Default Bootstrap z-index */
}

.modal-backdrop {
    z-index: 1040 !important; /* Make sure backdrop stays below */
}
/* Nuclear option to ensure interactivity */
#feedbackModal, 
#feedbackModal * {
  pointer-events: auto !important;
  user-select: text !important;
  -webkit-user-select: text !important;
}

/* Remove any potential overlays */
body.modal-open {
  overflow: auto !important;
  position: static !important;
}

/* Ensure modal is on top */
#feedbackModal {
  z-index: 99999 !important;
}
.file-upload {
    margin-bottom: 30px;
}

.file-input-container {
    position: relative;
    display: flex;
    align-items: center;
    margin-bottom: 15px;
}

.file-upload-label {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 12px 16px;
    border: 1px dashed #ddd;
    border-radius: 12px;
    background-color: var(--light);
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-upload-label:hover {
    border-color: var(--primary);
    background-color: rgba(79, 70, 229, 0.05);
}

#file-name {
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #666;
}

.browse-btn {
    background-color: var(--primary);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    margin-left: 10px;
}

.browse-btn:hover {
    background-color: var(--secondary);
}

.image-preview {
    max-width: 100%;
    height: 200px;
    border-radius: 12px;
    background-color: var(--light);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-top: 10px;
}

.image-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}
    </style>
</head>
<body>
    <div class="video-background">
        <video autoplay muted loop id="bg-video">
            <source src="./9667569-hd_1920_1080_25fps.mp4" type="video/mp4">
        </video>
    </div>
    <div class="container">
        <div class="content-area" id="mainContent">
            <!-- News Section -->
            <div id="news">
                <h2>Latest Updates</h2>
                <div id="newsContent">
                    <div class="news-item">
                        <h3>New Grievance Portal Launched in Dang</h3>
                        <p>Experience seamless complaint resolution with our AI-powered civic management system.</p>
                    </div>
                    <div class="news-item">
                        <h3>Improvement in Public Services</h3>
                        <p>40% faster resolution times achieved through digital transformation initiatives.</p>
                    </div>
                </div>
            </div>
            <!-- view profile -->
             <!-- Add this inside the profile section div (replace the existing placeholder) -->
<div id="profile" class="hidden">
    <h2>Your Profile</h2>
    <div class="profile-content">
        <form id="profileForm">
            <div class="two-col">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profileName" name="name" readonly>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="text" id="profilePhone" name="phonenumber" readonly>
                </div>
            </div>
            <div class="one-col">
                <div class="form-group">
                    <label>Taluka</label>
                    <input type="text" id="profileTaluka" name="taluka" readonly>
                </div>
            </div>
            <div class="one-col">
                <div class="form-group">
                    <label>City/Village</label>
                    <input type="text" id="profilePlace" name="place" readonly>
                </div>
            </div>
            <div class="form-group">
            <!-- Update the password section in your profile form -->
<div class="form-group">
    <label>Change Password</label>
    <div id="passwordChangeSection">
        <button type="button" id="initiatePasswordChange" class="btn btn-outline-primary" style="margin-bottom: 10px;">
            <i class="fas fa-lock"></i> Change Password
        </button>
        <div id="passwordChangeForm" style="display: none;">
            <div class="form-group">
                <label for="oldPassword">Current Password</label>
                <input type="password" id="oldPassword" class="form-control" placeholder="Enter your current password">
                <small id="oldPasswordError" class="text-danger" style="display: none;"></small>
            </div>
            <div class="form-group" id="newPasswordFields" style="display: none;">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
                <label for="confirmPassword" style="margin-top: 10px;">Confirm New Password</label>
                <input type="password" id="confirmPassword" class="form-control" placeholder="Confirm new password">
                <small id="passwordMatchError" class="text-danger" style="display: none;">Passwords don't match</small>
                <div class="password-strength" style="margin-top: 10px;">
                    <div class="progress" style="height: 5px;">
                        <div id="passwordStrength" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted">Password strength: <span id="strengthText">Weak</span></small>
                </div>
            </div>
            <div class="form-actions" style="margin-top: 15px;">
                <button type="button" id="cancelPasswordChange" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
                <button type="button" id="saveNewPassword" class="btn btn-primary" disabled>Save New Password</button>
            </div>
        </div>
    </div>
</div>
            </div>
            <div class="form-actions" style="display: none; margin-top: 20px;">
                <button type="button" id="cancelEdit" class="btn btn-secondary" style="margin-right: 10px;">Cancel</button>
                <button type="submit" id="saveProfile" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
        <button type="button" id="editProfile" class="btn btn-primary" style="margin-top: 20px;">
            <i class="fas fa-edit"></i> Edit Profile
        </button>
    </div>
</div>
            <!-- Complaint Section -->
            <div id="complaint" class="hidden">
                <div class="form-heading">File New Complaint</div>
                <form id="complaintForm" enctype="multipart/form-data" action="/uploadsom" method="POST">
                    <fieldset>
                        <legend>Personal Information</legend>
                        <div class="two-col">
                            <div class="form-group">
                                <label>Full Name <span class="required-star">*</span></label>
                                <input type="text" id="name" name="name" required placeholder="surname name father's_name">
                            </div>
                            <div class="form-group">
                                <label>Mobile Number <span class="required-star">*</span></label>
                                <input type="text" id="mobile" name="mobile"  placeholder="+919876543210" required>
                            </div>
                        </div>
                        <div class="two-col">
                            <div class="form-group">
                                <label>Taluka <span class="required-star">*</span></label>
                                <select id="taluka"  name="taluka"  required>
                                    <option value="">Select Taluka</option>
                                    <option value="Ahwa">Ahwa</option>
                                    <option value="Subir">Subir</option>
                                    <option value="Waghai">Waghai</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Location Type <span class="required-star">*</span></label>
                                <select id="locationType" name="locationType" required>
                                    <option value="">Select Type</option>
                                    <option value="village">Village</option>
                                    <option value="city">City</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Select Village/City <span class="required-star">*</span></label>
                            <select id="villageCity" name="villageCity"  required></select>
                        </div>
                        <div class="form-group">
                            <label>Complete Address <span class="required-star">*</span></label>
                            <textarea id="address" name="address" rows="3" required></textarea>
                        </div>
                        <div class="two-col">
                            <div class="form-group">
                                <label>Pincode <span class="required-star">*</span></label>
                                <input type="text" id="pincode" name="pincode" pattern="[0-9]{6}" required>
                            </div>
                            <div class="form-group">
                                <label>Exact Location of the problem <span class="required-star">*</span></label>
                                <textarea id="location" name="exactLocation"  rows="1" required></textarea>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Complaint Information</legend>
                        <div class="two-col">
                            <div class="form-group">
                                <label>Complaint Category <span class="required-star">*</span></label>
                                <select id="complaintCategory" name="complaintCategory"  required>
                                    <option value="">(શ્રેણી પસંદ કરો)Select Category</option>
                                    <option value="Water Supply"> (પાણી પુરવઠો) Water Supply</option>
                                    <option value="Traffic Signal"> (ટ્રાફિક સિગ્નલ) Traffic Signal</option>
                                    <option value="Swimming Pool"> (સ્વિમિંગ પુલ) Swimming Pool</option>
                                    <option value="Street Light"> (સ્ટ્રીટ લાઈટ) Street Light</option>
                                    <option value="Stray Dog Sterilization and ARV"> (રખડતા કુતરા) Stray Dog Sterilization and ARV</option>
                                    <option value="Stray Cattle"> (રખડતા ઢોર) Stray Cattle</option>
                                    <option value="Storm Water Drainage Project"> (વરસાદી ગટર પ્રોજેક્ટ) Storm Water Drainage Project</option>
                                    <option value="Public Toilet"> (જાહેર સૌચાલઈ) Public Toilet</option>
                                    <option value="Public Health"> (જાહેર આરોગ્ય) Public Health</option>
                                    <option value=" Parks and Garden"> (પાર્ક અને ગાર્ડેન) Parks and Garden</option>
                                    <option value="Open Defecation"> (જાહેરમાં શૌચાલય) Open Defecation</option>
                                    <option value="Mall Parking Fee Related"> (મોલ પાર્કિંગ ફી ને લગતી) Mall Parking Fee Related</option>
                                    <option value="Hospital And Dispensary"> (હોસ્પિટલ અને દવાખાના) Hospital And Dispensary</option>
                                    <option value="Gujarat Rural Urban Housing Scheme"> (ગુજરાત ગ્રામ્ય શહેરી હાઉસિંગ સ્કીમ) Gujarat Rural Urban Housing Scheme</option>
                                    <option value="Gas Line"> (ગેસ લાઈન) Gas Line</option>
                                    <option value="Garbage And Cleanliness"> (કચરો અને સફાઈ) Garbage And Cleanliness</option>
                                    <option value="Encroachment"> (એનક્રોચમેન્ટ(દબાણ)) Encroachment</option>
                                    <option value=" Emergency"> (ઈમરજેંસી) Emergency</option>
                                    <option value="E Waste"> (ઈ વેસ્ટ) E Waste</option>
                                    <option value="Drainage Project"> (ગટર પ્રોજેક્ટ) Drainage Project</option>
                                    <option value="Drainage And Storm Drain"> (ગટર અને વરસાદી ગટર) Drainage And Storm Drain</option>
                                    <option value="Door To Door Garbage Collection"> (કચરા ગાડી વિષે ની ફરીયાદ) Door To Door Garbage Collection</option>
                                    <option value="Dead Animals"> (મરેલા જાનવર) Dead Animals</option>
                                    <option value="City Bus Services"> (સિટી બસ સર્વિસીસ) City Bus Services</option>
                                    <option value="Birth And Death"> (જન્મ અને મરણ) Birth And Death</option>
                                    <option value="Auditorium"> (ઓડિટોરિયમ) Auditorium</option>
                                    <option value="Auditorium"> (અતિથિ ગૃહ) Auditorium</option>
                                    <option value="Assessment Tax Rebate"> (અસેસમેન્ટ ટેક્સ રિબેટ) Assessment Tax Rebate</option>
                                    <option value="Arogyam"> (આરોગ્યમ) Arogyam</option>
                                    <option value="Air Quality Management"> (હવાની ગુણવત્તા વ્યવસ્થાપન) Air Quality Management</option>
                                    <option value="Other"> ( અન્ય )  Other </option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Complaint Type <span class="required-star">*</span></label>
                                <select id="complaintType" name="complaintType">
                                    <option value="">Select Type</option>
                                </select>
                            </div>
                        </div>
                        <!-- In your form section -->
                        <div class="form-group">
                            <label>Problem Description <span class="required-star">*</span>
                            </label>
                            <textarea id="description" rows="5" name="problemDesc"></textarea>
                            <label>Record Audio:</label>
                            <button type="button" id="startRecording">Start Recording</button>
                            <button type="button" id="stopRecording" disabled>Stop Recording</button>
    
                            <audio id="audioPlayback" controls></audio>
    
                            <input type="file" name="audio" id="audio" accept="audio/*" hidden>

                            </div>
                            <div class="form-group file-upload">
                                <label>Upload a Picture <span class="required-star">*</span></label>
                                <div class="file-input-container">
                                    <input type="file" id="image" name="image" accept="image/*" required hidden>
                                    <label class="file-upload-label" for="image">
                                        <span id="file-name">No file chosen</span>
                                    </label>
                                    <button type="button" class="browse-btn">Browse Files</button>
                                </div>
                                <div class="image-preview"></div>
                            </div>
                        <button type="submit" id="submit-button">Submit Complaint</button>
                    </fieldset>
                </form>
                <div class="complaints-list">
                    <h3 class="section-header">Your Active Complaints</h3>
                    <div id="pendingComplaints"></div>
                </div>
            </div>
            <div class="hidden" id="statistics">
                <h2>Complaint Resolution Status</h2>
                <h3>1. Ahwa Taluka</h3>
                <canvas id="complaintChart"></canvas>
            </div>
            <!-- Status Section -->
            <div id="status" class="hidden">
                <h2>Your Complaint Status</h2>
                <div id="allComplaints" class="status-section"></div>
            </div>

            <!-- Profile Section (placeholder) -->
            <div id="profile" class="hidden">
                <h2>Your Profile</h2>
                <div class="profile-content">
                    <p>Profile information will be displayed here.</p>
                </div>
            </div>
        </div>
        <div class="nav-column">
            <div class="nav-column-inner"> <!-- Add this wrapper -->
                <button class="nav-button active-section" id="newsButton">
                    <i class="fas fa-newspaper"></i> Latest News
                </button>
                <button class="nav-button" id="statisticsButton">
                    <i class="fas fa-chart-bar"></i> Statistics
                </button>
                <button class="nav-button" id="complaintButton">
                    <i class="fas fa-edit"></i> File Complaint
                </button>
                <button class="nav-button" id="statusButton" onclick="updatePendingComplaints()">
                    <i class="fas fa-search"></i> Check Status
                </button>
                <button class="nav-button" id="profileButton">
                    <i class="fas fa-user"></i> Your Profile
                </button>
    </div>
    <div id="feedbackModal" style="
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
">
  <div style="
    background: white;
    width: 90%;
    max-width: 500px;
    margin: 30px auto;
    padding: 20px;
    border-radius: 8px;
    box-sizing: border-box;
  ">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
      <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Submit Your Feedback</h3>
      <button id="modalCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 0;">&times;</button>
    </div>
    
    <!-- Complaint ID -->
    <p style="margin-bottom: 15px;"><strong>Complaint ID:</strong> <span id="complaintIDDisplay" style="font-weight: bold;"></span></p>
    
    <!-- Feedback Form -->
    <form id="feedbackForm">
      <!-- Satisfaction Options -->
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 500;">How satisfied are you with the resolution?</label>
        
        <div style="margin-left: 5px;">
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="radio" id="outstanding" name="satisfaction" value="Outstanding Service" style="margin-right: 10px; width: 16px; height: 16px; flex-shrink: 0;">
            <label for="outstanding">🌟 Outstanding Service</label>
          </div>
          
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="radio" id="satisfactory" name="satisfaction" value="Satisfactory" style="margin-right: 10px; width: 16px; height: 16px; flex-shrink: 0;">
            <label for="satisfactory">✅ Satisfactory</label>
          </div>
          
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="radio" id="better" name="satisfaction" value="Could Be Better" style="margin-right: 10px; width: 16px; height: 16px; flex-shrink: 0;">
            <label for="better">⚡ Could Be Better</label>
          </div>
          
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="radio" id="improve" name="satisfaction" value="Needs Improvement" style="margin-right: 10px; width: 16px; height: 16px; flex-shrink: 0;">
            <label for="improve">❌ Needs Improvement</label>
          </div>
          
          <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <input type="radio" id="unacceptable" name="satisfaction" value="Not Acceptable" style="margin-right: 10px; width: 16px; height: 16px; flex-shrink: 0;">
            <label for="unacceptable">🚨 Not Acceptable</label>
          </div>
        </div>
      </div>
      
      <!-- Comments -->
      <div style="margin-bottom: 20px;">
        <label for="additionalFeedback" style="display: block; margin-bottom: 8px; font-weight: 500;">Additional Comments (Optional)</label>
        <textarea id="additionalFeedback" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-height: 80px; box-sizing: border-box;"></textarea>
      </div>
      
      <!-- Buttons - Improved alignment -->
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button id="cancelBtn" type="button" style="
          flex: 1;
          max-width: 120px;
          padding: 8px 0;
          background: #6c757d;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.9rem;
          line-height: 1.5;
          box-sizing: border-box;
          margin: 0;
        ">
          Cancel
        </button>
        <button id="submitBtn" type="submit" style="
          flex: 1;
          max-width: 120px;
          padding: 8px 0;
          background: #0d6efd;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.9rem;
          line-height: 1.5;
          box-sizing: border-box;
          margin: 0;
        ">
          Submit
        </button>
        <p id="successMessage" style="color: green; display: none;">Feedback submitted successfully!</p>
      </div>
    </form>
  </div>
</div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
      
    <script>
        let mediaRecorder;
    let audioChunks = [];

    document.getElementById("startRecording").addEventListener("click", async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById("audioPlayback").src = audioUrl;

            // Convert Blob to File
            const audioFile = new File([audioBlob], "recorded_audio.wav", { type: "audio/wav" });
            const fileInput = document.getElementById("audio");

            // Create DataTransfer to simulate file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(audioFile);
            fileInput.files = dataTransfer.files;
        };

        mediaRecorder.start();
        audioChunks = [];
        document.getElementById("startRecording").disabled = true;
        document.getElementById("stopRecording").disabled = false;
    });
    // $('.modal').modal('hide'); // Close any other open modals
// $('#feedbackModal').modal('show'); // Show the feedback modal

    document.getElementById("stopRecording").addEventListener("click", () => {
        mediaRecorder.stop();
        document.getElementById("startRecording").disabled = false;
        document.getElementById("stopRecording").disabled = true;
    });
    // ==== ADD IMAGE PREVIEW HANDLING BELOW ====
const imageInput = document.getElementById('image');
const fileNameDisplay = document.getElementById('file-name');
const imagePreview = document.querySelector('.image-preview');

// Trigger file input when browse button is clicked
document.querySelector('.browse-btn').addEventListener('click', () => imageInput.click());

// Handle file selection and preview
imageInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
        const file = this.files[0];
        fileNameDisplay.textContent = file.name;
        
        // Create and display image preview
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.innerHTML = `<img src="${e.target.result}" 
                                      alt="Preview" 
                                      style="max-width: 100%; 
                                             max-height: 200px;
                                             object-fit: contain;">`;
        };
        reader.readAsDataURL(file);
    } else {
        fileNameDisplay.textContent = 'No file chosen';
        imagePreview.innerHTML = '';
    }
});
        const locations = {
            Ahwa: [
                'Ahwa', 'Baripada', 'Bhavandagad', 'Borkhal', 'Chankhal', 'Chaukiya', 'Chinchli', 'Dhavalidod', 
                'Diwan Tembrun', 'Gadhvi', 'Galkund', 'Ghoghl', 'Gondalvihir', 'Gotiyamal', 'Harpada', 
                'Lahancharcha', 'Linga', 'Mahalpada', 'Malegaon', 'Morzira', 'Pimpri', 'Samgahan', 
                'Taklipada (Pipalaidevi)', 'Wasurna', 'Chikatya', 'Jakhana', 'Don'
            ],
            Subir: [
                'Subir', 'Bardipada (Saja)', 'Chinchvihir', 'Daher', 'Garkhadi', 'Gavdahad', 
                'Hanwatpada (Pipaldahadsaja)', 'Kadmal (Subir)', 'Kakshala', 'Keshbandh', 'Khambhla', 
                'Kirli', 'Lavchali', 'Mahal', 'Malga', 'Naktia Hanwat', 'Pipalai Devi', 'Pipaldahad', 
                'Shempuamba', 'Singana', 'Subir'
            ],
            Waghai: [
                'Waghai', 'Barkhandhia', 'Bhalkhet', 'Bhendmal', 'Bhenskatri', 'Chichigaontha', 
                'Chikar (Jhavdasaja)', 'Chinchod', 'Dagadiamba', 'Daguniya', 'Dokpatal', 'Godadiya', 
                'Jhariya (Dungarda)', 'Jhavda', 'Khatal', 'Kosimda', 'Manmodi', 'Nadakchond', 
                'Nanapada', 'Rambhas', 'Sakarpatal', 'Sarwar', 'Kalibel'
            ]
        };

        const complaintTypes = {
            "Water Supply": [
                { value: " Contaminated Water (Impure)", text: " ( અશુદ્ધ, ક્ન્ટામિનેટેડ પાણી  )  Contaminated Water (Impure)" },
                { value: " Direct Motor Running", text: " ( ડાયરેક્ટ મોટર ચલાવવી )  Direct Motor Running" },
                { value: "Illegal Connection", text: " ( ગેરકાયદેસર જોડાણ )  Illegal Connection" },
                { value: "Insufficient Water Supply Duration", text: " ( અપૂરતો પાણી વિતરણનો સમય ગાળો   )  Insufficient Water Supply Duration" },
                { value: "Leakage of Public Stand Post", text: " ( જાહેર સ્ટેન્ડ પોસ્ટની દુરસ્તી  )  Leakage of Public Stand Post" },
                { value: "Low Water Pressure", text: " ( નીચા પાણીનું દબાણ  )  Low Water Pressure" },
                { value: "Main Feeder Line Leakage", text: " ( મુખ્ય નળીકા / ફીડલ નળીકા લીકેજ  )  Main Feeder Line Leakage" },
                { value: "Pipeline Leakage", text: " ( પાઇપલાઈન લીકેજ  )  Pipeline Leakage" },
                { value: "Reduction of Chlorination Intensity", text: " ( પીવાના પાણી પુરવઠામાં કલોરીનીકરણની તીવ્રતા સ્તર ઘટાડો  )  Reduction of Chlorination Intensity" },
                { value: "Valve Repairing", text: " ( વાલ્વ રિપેરિંગની  ફરિયાદો )  Valve Repairing" },
                { value: "Repairing of Hand Pump", text: " ( હેન્ડ પંપ સમારકામ )  Repairing of Hand Pump" },
                { value: "Valve Leakage", text: " ( વાલ્વ લીકેજ  )  Valve Leakage" },
                { value: "Water Network Not Exist", text: " ( પાણીનું નેટવર્ક હયાત નથી )  Water Network Not Exist" },
                { value: "Water Supply Not Received", text: " ( પાણી પુરવઠો મળ્યો નથી  )  Water Supply Not Received" },
                { value: "Other", text: " ( અન્ય )  Other" }
            ],
            "Traffic Signal": [
                { value: "Advertise Related Issue", text: " ( જાહેરાત અંગે સમસ્યા )  Advertise Related Issue" },
                { value: "  Display Board Not Working", text: " ( ડિસ્પ્લે બોર્ડ નથી ચાલતું )  Display Board Not Working" },
                { value: "Mal Function", text: " ( સમાન સંકેત (માલ ફંક્શન) )  Mal Function" },
                { value: "Pole Damage", text: " ( થાંભલો જોખમી છે )  Pole Damage" },
                { value: "Signal Light Damage", text: " ( લાઈટમાં નુકસાન છે )  Signal Light Damage" },
                { value: "Signal Not Working", text: " ( સિગ્નલ ચાલતું નથી )  Signal Not Working" },
                { value: "Signal Timing Improper", text: " ( સિગ્નલ ટાઈમ અયોગ્ય )  Signal Timing Improper" },
                { value: "Other", text: " ( અન્ય  )  Other" }
            ],
            "Swimming Pool": [
                { value: " Cleanliness Issue", text: " ( સ્વચ્છતાની સમસ્યા )  Cleanliness Issue" },
                { value: "High Chlorine", text: " ( વધુ ક્લોરીન )  High Chlorine" },
                { value: "Not Taking Care of Hygiene", text: " ( સ્વચ્છતાની કાળજી રાખતા નથી )  Not Taking Care of Hygiene" },
                { value: "Shower Not Working", text: " ( ફુવારો ચાલતો નથી )  Shower Not Working" },
                { value: "Staff Not Present", text: " ( કર્મચારી હાજર નથી )  Staff Not Present" },
                { value: " Water Not Changed", text: " ( પાણી બદલાતુ નથી )  Water Not Changed" },
                { value: "Water Not Cleaned", text: " ( પાણીની સફાઈ થયેલ નથી )  Water Not Cleaned" },
                { value: "Other", text: " ( અન્ય )  Other" }
            ],
            "Street Light": [
                { value: "Area Street Light Not Working", text: " ( વિસ્તારમાં સ્ટ્રીટ લાઈટ ચાલતી નથી  )  Area Street Light Not Working" },
                { value: "Electric Shock/Current Leakage on Pole", text: " ( થાંબલા પર ઈલેક્ટ્રીક શોક / હાલના થાંબલા પર લિકેજ )  Electric Shock/Current Leakage on Pole" },
                { value: " Insufficient Lighting", text: " ( અપૂરતો પ્રકાશ  )  Insufficient Lighting" },
                { value: "LED Light Not Working", text: " ( LED લાઈટ ચાલતી નથી  )  LED Light Not Working" },
                { value: "Overhead Line Problem", text: " ( ઓવરહેડ લાઈન સમસ્યા  )  Overhead Line Problem" },
                { value: "Pole is in Dangerous Condition", text: " ( થાંબલો જોખમકારક પરિસ્થિતિમાં છે  )  Pole is in Dangerous Condition" },
                { value: "Removable of Unserviceable Street Light", text: " ( નકામી સ્ટ્રીટ લાઈટ દુર કરવા બાબત  )  Removable of Unserviceable Street Light" },
                { value: "Sodium Light Not Working", text: " ( સોડીયમ લાઈટ ચાલતી નથી  )  Sodium Light Not Working" },
                { value: " Sparking on Street Light Pole", text: " ( સ્ટ્રીટ લાઈટ ના થાંબલા ઉપર સ્પાર્કીંગ   )  Sparking on Street Light Pole" },
                { value: " Switching ON/OFF Time Problem", text: " ( લાઈટ ચાલુ / બંધ ના સમયની સમસ્યા  )  Switching ON/OFF Time Problem" },
                { value: " Tube Light Not Working", text: " ( ટ્યુબ લાઈટ ચાલતી નથી  )  Tube Light Not Working" },
                { value: "Other", text: " ( અન્ય  )  Other" }
            ]
        };
        let phoneNumber = sessionStorage.getItem('citizenMobile');
 // Function to display status information
 
async function updatePendingComplaints() {
    console.log("updatePendingComplaints called");
    try {
        const mobile = sessionStorage.getItem("citizenMobile");
        if (!mobile) {
            console.error("No mobile number found in sessionStorage.");
            const errorMsg = '<p class="text-danger">Please log in first.</p>';
            document.getElementById('pendingComplaints').innerHTML = errorMsg;
            document.getElementById('allComplaints').innerHTML = errorMsg;
            return;
        }
        
        console.log("Fetching complaints for mobile:", mobile);
        const response = await fetch(`/omcitizen?mobile=${mobile}`);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch complaints. Status: ${response.status}`);
        }

        const complaints = await response.json();
        console.log("Complaints data received:", complaints);

        if (!complaints || !Array.isArray(complaints)) {
            throw new Error("Invalid complaints data format");
        }

        // Create HTML content for complaints
        const htmlContent = complaints.length ? complaints.map(complaint => {
            // Create status badge with appropriate class
            const statusClass = complaint.ostatus ? 
                complaint.ostatus.toLowerCase().replace(' ', '-') : 'pending';
            if(complaint.ostatus === 'Resolved')
            {
                setTimeout(() => {
                    sessionStorage.setItem('status',complaint.complaintid)
                    showFeedbackModal(complaint.complaintid);
                    // Mark this feedback as shown to prevent duplicates
                    sessionStorage.setItem(`feedbackShown_${complaint.complaintid}`, 'true');
                }, 500);
            
            }
            
            return `
                <div class="complaint-card mb-3">
                    <div class="complaint-header">
                        <strong>Complaint ID:</strong> ${complaint.complaintid || 'N/A'}
                    </div>
                    <div class="complaint-body">
                        <p><strong>Department:</strong> ${complaint.department || 'N/A'}</p>
                        <p><strong>Description:</strong> ${complaint.complaintdesc || 'N/A'}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${complaint.ostatus || 'Pending'}</span></p>
                        <p><strong>Location:</strong> ${complaint.proloc || 'N/A'}</p>
                        ${complaint.image_url ? `<p><strong>Image:</strong> <a href="${complaint.image_url}" target="_blank">View</a></p>` : ''}
                    </div>
                    <div class="complaint-footer">
                        <small class="text-muted">Submitted on: ${complaint.created_at || 'Date not available'}</small>
                    </div>
                </div>
            `;
        }).join('') : '<div class="alert alert-info">No complaints found for your account.</div>';

        console.log("Generated HTML content:", htmlContent);
        
        // Update both sections with the same content
        document.getElementById('pendingComplaints').innerHTML = htmlContent;
        document.getElementById('allComplaints').innerHTML = htmlContent;

        // Show feedback modal for resolved complaints
        complaints.forEach(complaint => {
            if(complaint.ostatus === 'Resolved' && !sessionStorage.getItem(`feedbackShown_${complaint.complaintid}`)) {
                setTimeout(() => {
                    showFeedbackModal(complaint.complaintid);
                    sessionStorage.setItem(`feedbackShown_${complaint.complaintid}`, 'true');
                }, 500);
            }
        });

    } catch (error) {
        console.error('Error in updatePendingComplaints:', error);
        const errorMsg = `<div class="alert alert-danger">Error loading complaints: ${error.message}</div>`;
        document.getElementById('pendingComplaints').innerHTML = errorMsg;
        document.getElementById('allComplaints').innerHTML = errorMsg;
    }
}
document.getElementById("feedbackForm").addEventListener("submit", async function (event) {
  event.preventDefault(); // Prevent page reload

  // Get Complaint ID
  const complaintID = sessionStorage.getItem('status');

  // Get selected satisfaction rating
  const satisfaction = document.querySelector('input[name="satisfaction"]:checked');
  if (!satisfaction) {
    alert("Please select a satisfaction level.");
    return;
  }

  // Get additional feedback
  const additionalFeedback = document.getElementById("additionalFeedback").value;

  // Prepare data to send
  const feedbackData = {
    complaintID: complaintID,
    satisfaction: satisfaction.value,
    additionalFeedback: additionalFeedback.trim(),
  };

  try {
    // Send feedback to backend
    const response = await fetch("/feedback", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(feedbackData),
    });

    // Check response
    const result = await response.json();
    if (response.ok) {
      document.getElementById("successMessage").style.display = "block";
      console.log("Feedback submitted:", result);
    } else {
      alert("Failed to submit feedback. Please try again.");
    }
  } catch (error) {
    console.error("Error:", error);
    alert("Error submitting feedback.");
  }
});

// Update the showSection function to handle status section
function showSection(sectionId) {
    // Remove active class from all buttons
    document.querySelectorAll('.nav-button').forEach(function(btn) {
        btn.classList.remove('active-section');
    });
    
    // Hide all sections
    document.querySelectorAll('#mainContent > div').forEach(function(section) {
        section.classList.add('hidden');
    });
    
    // Activate the correct button
    const activeBtn = document.getElementById(`${sectionId}Button`);
    if (activeBtn) {
        activeBtn.classList.add('active-section');
    }
    
    // Show the selected section
    const activeSection = document.getElementById(sectionId);
    if (activeSection) {
        activeSection.classList.remove('hidden');
    }
    
    // Special handling for status section
    if (sectionId === 'status') {
        updatePendingComplaints(); // Refresh complaints when status section is shown
    }
    
    // Special handling for statistics section
    if (sectionId === 'statistics') {
        setTimeout(updateStatistics, 10);
    }
}

// Update event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Navigation buttons
    document.getElementById('newsButton').addEventListener('click', () => showSection('news'));
    document.getElementById('statisticsButton').addEventListener('click', () => showSection('statistics'));
    document.getElementById('complaintButton').addEventListener('click', () => showSection('complaint'));
    document.getElementById('statusButton').addEventListener('click', () => showSection('status'));
    document.getElementById('profileButton').addEventListener('click', () => showSection('profile'));

    // Form event listeners
    document.getElementById('taluka').addEventListener('change', updateVillageCityOptions);
    document.getElementById('locationType').addEventListener('change', updateVillageCityOptions);
    document.getElementById('complaintCategory').addEventListener('change', updateComplaintType);

    // Initialize the app
    showSection('news');
    updatePendingComplaints(); // Load complaints on initial page load
});
document.addEventListener("DOMContentLoaded", async function () {
    const mobile = sessionStorage.getItem("citizenMobile");

    if (!mobile) {
        console.error("No mobile number found in sessionStorage.");
        return;
    }

    console.log("Mobile found in sessionStorage:", mobile);
    await autoFill(mobile);
});
async function autoFill(mobile) {
    // const mobile = document.getElementById("mobileInput").value.trim();

    // Debugging log
    console.log("Mobile number before request:", mobile);

    if (!mobile) {
        console.error("❌ Mobile number is missing!");
        alert("Please enter a valid mobile number.");
        return;
    }

    try {
        const citizen = await fetch(`/autofill?mobile=${encodeURIComponent(mobile)}`);
        console.log("Response URL:", `/autofill?mobile=${encodeURIComponent(mobile)}`);
        console.log("Response status:", citizen.status);
        

        if (!citizen.ok) {
            throw new Error(`Server error: ${citizen.status} - ${await citizen.text()}`);
        }
        const data = await citizen.json();
        
        document.getElementById('name').value = data.nameofcitizen || "";
        document.getElementById('mobile').value = data.phonenumber || "";
        document.getElementById('taluka').value = data.taluka || "";
        // document.getElementById('villageCity').value = citizen.village || "";
        console.log("Auto-fill data:", data);
    } catch (error) {
        console.error("Auto-fill error:", error);
    }
}
// Modal control functions
function showFeedbackModal(complaintId) {
  const modal = document.getElementById('feedbackModal');
  if (!modal) return;
  
  document.getElementById('complaintIDDisplay').textContent = complaintId;
  modal.style.display = 'block';
}

function hideFeedbackModal() {
  const modal = document.getElementById('feedbackModal');
  if (modal) {
    modal.style.display = 'none';
    sessionStorage.removeItem('status');
  }
}

// Set up event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  // Close button
  const closeBtn = document.getElementById('modalCloseBtn');
  if (closeBtn) {
    closeBtn.addEventListener('click', hideFeedbackModal);
  }
  
  // Cancel button
  const cancelBtn = document.getElementById('cancelBtn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', hideFeedbackModal);
  }
  
  // Form submission
  const feedbackForm = document.getElementById('feedbackForm');
  if (feedbackForm) {
    feedbackForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const satisfaction = document.querySelector('input[name="satisfaction"]:checked')?.value;
      const comments = document.getElementById('additionalFeedback').value;
      
      console.log('Feedback submitted:', {
        complaintId: document.getElementById('complaintIDDisplay').textContent,
        satisfaction,
        comments
      });
      
      hideFeedbackModal();
    });
  }
  
  // Show modal if there's a resolved complaint
  const resolvedId = sessionStorage.getItem('status');
  if (resolvedId) {
    showFeedbackModal(resolvedId);
  }
});
document.getElementById('statusButton').addEventListener('click', function() {
    showSection('status');
    updatePendingComplaints(); // Fetch and display complaints
});
document.addEventListener('DOMContentLoaded', function() {
    // Other initialization code...
    updatePendingComplaints(); // Call this function on page load
});

        document.addEventListener("DOMContentLoaded", updatePendingComplaints);

        // Function to update village/city options based on selected taluka
        function updateVillageCityOptions() {
            const taluka = document.getElementById('taluka').value;
            const select = document.getElementById('villageCity');
            
            // Clear current options
            select.innerHTML = `<option value="">Select Village</option>`;
            
            // Add new options if taluka is selected
            if (taluka && locations[taluka]) {
                locations[taluka].forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    select.appendChild(option);
                });
            }
        }
        // Function to update complaint type options based on selected category
        function updateComplaintType() {
            const category = document.getElementById('complaintCategory').value;
            const typeSelect = document.getElementById('complaintType');
            
            // Clear current options
            typeSelect.innerHTML = `<option value="">Select Type</option>`;
            
            // Add new options if category is selected
            if (category && complaintTypes[category]) {
                complaintTypes[category].forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.value;
                    option.textContent = type.text;
                    typeSelect.appendChild(option);
                });
            }
        }
            updatePendingComplaints();
            updateStatistics();
        function editComplaint(id) {
            const complaints = JSON.parse(localStorage.getItem('complaints')) || [];
            const complaint = complaints.find(c => c.id === id);
            
            if (complaint) {
                // Show complaint section
                showSection('complaint');
                
                // Fill form with complaint data
                document.getElementById('name').value = complaint.name;
                document.getElementById('mobile').value = complaint.mobile;
                document.getElementById('taluka').value = complaint.taluka;
                document.getElementById('locationType').value = complaint.locationType;
                
                // Update dependent dropdowns
                updateVillageCityOptions();
                
                // Set village/city after options are populated
                setTimeout(() => {
                    document.getElementById('villageCity').value = complaint.villageCity;
                }, 100);
                
                document.getElementById('address').value = complaint.address;
                document.getElementById('pincode').value = complaint.pincode;
                document.getElementById('location').value = complaint.problemLocation;
                
                // Set complaint category and update type options
                document.getElementById('complaintCategory').value = complaint.complaintCategory;
                updateComplaintType();
                
                // Set complaint type after options are populated
                setTimeout(() => {
                    document.getElementById('complaintType').value = complaint.complaintType;
                }, 100);
                
                document.getElementById('description').value = complaint.description;
                
                // Scroll to complaint form
                window.scrollTo({
                    top: document.getElementById('complaint').offsetTop,
                    behavior: 'smooth'
                });
            }
        }
        async function updateStatistics() {
    try {
        const response = await fetch('/plot-graphs');
        const data = await response.json();
        
        console.log("Fetched Data:", data);

        if (typeof data.resolved !== "number" || typeof data.pending !== "number") {
            console.error("Invalid Data Structure:", data);
            return;
        }

        const ctx = document.getElementById('complaintChart').getContext('2d');

        // Only destroy if it's a valid Chart instance
        if (window.complaintChart && typeof window.complaintChart.destroy === 'function') {
            window.complaintChart.destroy();
        }

        window.complaintChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Resolved', 'Pending'],
                datasets: [{
                    data: [data.resolved, data.pending],
                    backgroundColor: ['#4CAF50', '#FF5733']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

    } catch (error) {
        console.error("Error fetching data:", error);
    }
}
// Add this to your existing JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Load profile data when profile section is shown
    document.getElementById('profileButton').addEventListener('click', loadProfileData);
    
    // Edit profile button
    document.getElementById('editProfile').addEventListener('click', enableProfileEditing);
    
    // Cancel edit button
    document.getElementById('cancelEdit').addEventListener('click', cancelProfileEditing);
    
    // Save profile button
    document.getElementById('profileForm').addEventListener('submit', saveProfileChanges);
});

async function loadProfileData() {
    try {
        const mobile = sessionStorage.getItem('citizenMobile');
        if (!mobile) {
            console.error('No mobile number in session');
            return;
        }
        
        const encodedMobile = encodeURIComponent(mobile);  
        const response = await fetch(`/getProfile?mobile=${encodedMobile}`);
        if (!response.ok) {
            throw new Error('Failed to fetch profile data');
        }
        
        const profileData = await response.json();
        
        // Fill the form with profile data
        document.getElementById('profileName').value = profileData.nameofcitizen || '';
        document.getElementById('profilePhone').value = profileData.phonenumber || '';
        document.getElementById('profileTaluka').value = profileData.taluka || '';
        document.getElementById('profilePlace').value = profileData.village || '';
        
    } catch (error) {
        console.error('Error loading profile:', error);
        alert('Failed to load profile data');
    }
}

function enableProfileEditing() {
    // Remove readonly attribute from editable fields
    const inputs = document.querySelectorAll('#profileForm input');
    inputs.forEach(input => {
        if (input.id !== 'profilePhone') { // Don't allow phone number editing
            input.removeAttribute('readonly');
        }
    });
    
    // Show save/cancel buttons
    document.querySelector('.form-actions').style.display = 'block';
    
    // Hide edit button
    document.getElementById('editProfile').style.display = 'none';
}

function cancelProfileEditing() {
    // Restore readonly attribute
    const inputs = document.querySelectorAll('#profileForm input');
    inputs.forEach(input => {
        input.setAttribute('readonly', true);
    });
    
    // Hide save/cancel buttons
    document.querySelector('.form-actions').style.display = 'none';
    
    // Show edit button
    document.getElementById('editProfile').style.display = 'block';
    
    // Reload original data
    loadProfileData();
}

async function saveProfileChanges(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData(document.getElementById('profileForm'));
        const mobile = sessionStorage.getItem('citizenMobile');
        
        // Add mobile to form data
        formData.append('mobile', mobile);
        
        const response = await fetch('/updateProfile', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('Failed to update profile');
        }
        
        const result = await response.json();
        if (result.success) {
            alert('Profile updated successfully!');
            cancelProfileEditing(); // Reset to read-only mode
        } else {
            throw new Error(result.message || 'Update failed');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}   
// Password change functionality
document.addEventListener('DOMContentLoaded', function() {
    const initiateBtn = document.getElementById('initiatePasswordChange');
    const passwordForm = document.getElementById('passwordChangeForm');
    const oldPasswordInput = document.getElementById('oldPassword');
    const newPasswordFields = document.getElementById('newPasswordFields');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const savePasswordBtn = document.getElementById('saveNewPassword');
    const cancelPasswordBtn = document.getElementById('cancelPasswordChange');
    const oldPasswordError = document.getElementById('oldPasswordError');
    const passwordMatchError = document.getElementById('passwordMatchError');
    const passwordStrengthBar = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');

    // Toggle password change form
    initiateBtn.addEventListener('click', function() {
        passwordForm.style.display = 'block';
        initiateBtn.style.display = 'none';
    });

    // Cancel password change
    cancelPasswordBtn.addEventListener('click', function() {
        resetPasswordForm();
    });

    // Verify old password
    oldPasswordInput.addEventListener('blur', async function() {
        if (oldPasswordInput.value.trim() === '') return;
        
        try {
            const mobile = sessionStorage.getItem('citizenMobile');
            const response = await fetch('/verifyPassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mobile: mobile,
                    password: oldPasswordInput.value
                })
            });

            const result = await response.json();
            
            if (result.valid) {
                oldPasswordError.style.display = 'none';
                newPasswordFields.style.display = 'block';
                oldPasswordInput.readOnly = true;
            } else {
                oldPasswordError.textContent = 'Incorrect password';
                oldPasswordError.style.display = 'block';
                newPasswordFields.style.display = 'none';
            }
        } catch (error) {
            console.error('Error verifying password:', error);
            oldPasswordError.textContent = 'Error verifying password';
            oldPasswordError.style.display = 'block';
        }
    });

    // Check password match and strength
    newPasswordInput.addEventListener('input', checkPasswordStrength);
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);

    // Save new password
    savePasswordBtn.addEventListener('click', async function() {
        if (!validatePasswordChange()) return;
        
        try {
            const mobile = sessionStorage.getItem('citizenMobile');
            const response = await fetch('/updatePassword', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mobile: mobile,
                    oldPassword: oldPasswordInput.value,
                    newPassword: newPasswordInput.value
                })
            });

            const result = await response.json();
            
            if (result.success) {
                alert('Password changed successfully!');
                resetPasswordForm();
            } else {
                alert('Failed to change password: ' + (result.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error changing password:', error);
            alert('Failed to change password. Please try again.');
        }
    });

    function checkPasswordStrength() {
        const password = newPasswordInput.value;
        let strength = 0;
        
        // Length check
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        
        // Complexity checks
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        // Update UI
        const strengthPercent = Math.min(100, strength * 25);
        passwordStrengthBar.style.width = strengthPercent + '%';
        
        // Update strength text and color
        let strengthClass = 'weak';
        let text = 'Weak';
        
        if (strength >= 4) {
            strengthClass = 'moderate';
            text = 'Moderate';
        }
        if (strength >= 5) {
            strengthClass = 'strong';
            text = 'Strong';
        }
        if (strength >= 6) {
            strengthClass = 'very-strong';
            text = 'Very Strong';
        }
        
        passwordStrengthBar.className = 'progress-bar ' + strengthClass;
        strengthText.textContent = text;
        strengthText.className = strengthClass;
    }

    function checkPasswordMatch() {
        if (newPasswordInput.value && confirmPasswordInput.value) {
            if (newPasswordInput.value !== confirmPasswordInput.value) {
                passwordMatchError.style.display = 'block';
                savePasswordBtn.disabled = true;
            } else {
                passwordMatchError.style.display = 'none';
                savePasswordBtn.disabled = false;
            }
        }
    }

    function validatePasswordChange() {
        if (!oldPasswordInput.value) {
            oldPasswordError.textContent = 'Please enter current password';
            oldPasswordError.style.display = 'block';
            return false;
        }
        
        if (!newPasswordInput.value) {
            alert('Please enter a new password');
            return false;
        }
        
        if (newPasswordInput.value !== confirmPasswordInput.value) {
            passwordMatchError.style.display = 'block';
            return false;
        }
        
        // Additional password strength validation if needed
        if (newPasswordInput.value.length < 8) {
            alert('Password must be at least 8 characters long');
            return false;
        }
        
        return true;
    }

    function resetPasswordForm() {
        passwordForm.style.display = 'none';
        initiateBtn.style.display = 'block';
        oldPasswordInput.value = '';
        newPasswordInput.value = '';
        confirmPasswordInput.value = '';
        newPasswordFields.style.display = 'none';
        oldPasswordInput.readOnly = false;
        oldPasswordError.style.display = 'none';
        passwordMatchError.style.display = 'none';
        passwordStrengthBar.style.width = '0%';
        strengthText.textContent = 'Weak';
        savePasswordBtn.disabled = true;
    }
});
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
